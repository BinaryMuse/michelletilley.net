<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-0J9FB4C3GB"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-0J9FB4C3GB");
    </script>
    <script>
      // Load theme preference before paint to prevent flash
      (function () {
        var theme = localStorage.getItem("theme");
        if (theme === "light") {
          document.documentElement.setAttribute("data-theme", "light");
        }
      })();
    </script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}{{ config.title }}{% endblock %}</title>
    <meta
      name="description"
      content="{% block description %}{{ config.description }}{% endblock %}"
    />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" href="/favicon.ico" />

    <!-- Open Graph / Facebook -->
    <meta
      property="og:type"
      content="{% block og_type %}website{% endblock %}"
    />
    <meta
      property="og:url"
      content="{{ current_url | default(value=config.base_url) }}"
    />
    <meta
      property="og:title"
      content="{% block og_title %}{{ config.title }}{% endblock %}"
    />
    <meta
      property="og:description"
      content="{% block og_description %}{{ config.description }}{% endblock %}"
    />
    <meta property="og:site_name" content="{{ config.title }}" />
    {% block og_image %}{% endblock %}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:url"
      content="{{ current_url | default(value=config.base_url) }}"
    />
    <meta
      name="twitter:title"
      content="{% block twitter_title %}{{ config.title }}{% endblock %}"
    />
    <meta
      name="twitter:description"
      content="{% block twitter_description %}{{ config.description }}{% endblock %}"
    />
    {% block twitter_image %}{% endblock %}

    <!-- Canonical URL -->
    <link
      rel="canonical"
      href="{{ current_url | default(value=config.base_url) }}"
    />

    <!-- Author -->
    <meta name="author" content="{{ config.extra.author }}" />

    <!-- Additional article metadata (for blog posts) -->
    {% block article_meta %}{% endblock %}

    <link rel="stylesheet" href="/style.css" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS"
      href="/rss.xml"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/katex.min.css"
      integrity="sha384-Wsr4Nh3yrvMf2KCebJchRJoVo1gTU6kcP05uRSh5NV3sj9+a8IomuJoQzf3sMq4T"
      crossorigin="anonymous"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/katex.min.js"
      integrity="sha384-+W9OcrYK2/bD7BmUAk+xeFAyKp0QjyRQUCxeU31dfyTt/FrPsUgaBTLLkVf33qWt"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/contrib/auto-render.min.js"
      integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh"
      crossorigin="anonymous"
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body);
      });
    </script>
  </head>
  <body>
    <header class="site-header">
      <nav>
        <a href="/" class="site-title">{{ config.title }}</a>
        <ul class="nav-links">
          <li><a href="/blog">Blog</a></li>
          <li><a href="/notes">Notes</a></li>
          <li><a href="/categories">Categories</a></li>
          <li>
            <button
              class="theme-toggle"
              aria-label="Toggle light mode"
              title="Toggle light mode"
            >
              <span class="theme-icon-sun" aria-hidden="true">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 16 16"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <circle cx="8" cy="8" r="3" fill="currentColor" />
                  <line
                    x1="8"
                    y1="1"
                    x2="8"
                    y2="2.5"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                  />
                  <line
                    x1="8"
                    y1="13.5"
                    x2="8"
                    y2="15"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                  />
                  <line
                    x1="15"
                    y1="8"
                    x2="13.5"
                    y2="8"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                  />
                  <line
                    x1="2.5"
                    y1="8"
                    x2="1"
                    y2="8"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                  />
                  <line
                    x1="12.5"
                    y1="3.5"
                    x2="11.5"
                    y2="4.5"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                  />
                  <line
                    x1="4.5"
                    y1="11.5"
                    x2="3.5"
                    y2="12.5"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                  />
                  <line
                    x1="12.5"
                    y1="12.5"
                    x2="11.5"
                    y2="11.5"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                  />
                  <line
                    x1="4.5"
                    y1="4.5"
                    x2="3.5"
                    y2="3.5"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                  />
                </svg>
              </span>
              <span class="theme-icon-moon" aria-hidden="true">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 16 16"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M8 2C7.5 2 7 2.1 6.5 2.2C8.5 3.2 9.8 5.3 9.8 7.7C9.8 10.1 8.5 12.2 6.5 13.2C7 13.3 7.5 13.4 8 13.4C11.1 13.4 13.6 10.9 13.6 7.8C13.6 4.7 11.1 2.2 8 2.2V2Z"
                    fill="currentColor"
                  />
                </svg>
              </span>
            </button>
          </li>
        </ul>
      </nav>
    </header>

    <main>{% block content %}{% endblock %}</main>

    <footer>
      <p>&copy; {{ now() | date(format="%Y") }} {{ config.extra.author }}</p>
    </footer>

    <script>
      // Mark truly adjacent footnote references (no text nodes between)
      document.querySelectorAll(".footnote-reference").forEach((el) => {
        const prev = el.previousSibling;
        if (
          prev &&
          prev.nodeType === Node.ELEMENT_NODE &&
          prev.classList.contains("footnote-reference")
        ) {
          el.classList.add("adjacent");
        }
      });

      // Theme toggle
      (function () {
        var toggle = document.querySelector(".theme-toggle");
        if (!toggle) return;

        toggle.addEventListener("click", function () {
          var html = document.documentElement;
          var currentTheme = html.getAttribute("data-theme");
          var newTheme = currentTheme === "light" ? "dark" : "light";

          html.setAttribute("data-theme", newTheme);
          localStorage.setItem("theme", newTheme);
        });
      })();

      // Footnote popups (progressive enhancement)
      (function () {
        var popup = null;
        var currentReference = null;

        function createPopup() {
          if (popup) return popup;

          popup = document.createElement("div");
          popup.className = "footnote-popup";
          popup.innerHTML =
            '<button class="footnote-close" aria-label="Close">&times;</button><div class="footnote-content"></div>';
          document.body.appendChild(popup);

          popup
            .querySelector(".footnote-close")
            .addEventListener("click", closePopup);

          return popup;
        }

        function positionPopup(referenceEl) {
          var rect = referenceEl.getBoundingClientRect();
          var popupRect = popup.getBoundingClientRect();

          var left = rect.left + rect.width / 2 - 30;
          var top = rect.bottom + window.scrollY + 10;

          // Adjust if popup would go off-screen
          if (left + popupRect.width > window.innerWidth - 20) {
            left = window.innerWidth - popupRect.width - 20;
          }
          if (left < 20) {
            left = 20;
          }

          popup.style.left = left + "px";
          popup.style.top = top + "px";
        }

        function showPopup(referenceEl, footnoteId) {
          var footnoteEl = document.getElementById(footnoteId);
          if (!footnoteEl) return;

          createPopup();

          // Clone the footnote content (excluding the back reference)
          var content = footnoteEl.cloneNode(true);
          var backRef = content.querySelector(".footnote-backref");
          if (backRef) backRef.remove();

          var contentDiv = popup.querySelector(".footnote-content");
          contentDiv.innerHTML = "";
          contentDiv.appendChild(content);

          currentReference = referenceEl;
          positionPopup(referenceEl);

          // Show popup after a brief delay to ensure positioning
          setTimeout(function () {
            popup.classList.add("visible");
          }, 10);
        }

        function closePopup() {
          if (!popup) return;
          popup.classList.remove("visible");
          currentReference = null;
        }

        // Handle clicks on footnote references
        document.addEventListener("click", function (e) {
          var target = e.target;

          // Check if we clicked a link inside a footnote reference
          var footnoteRef = null;
          if (
            target.tagName === "A" &&
            target.parentElement &&
            target.parentElement.classList.contains("footnote-reference")
          ) {
            e.preventDefault();
            footnoteRef = target.parentElement;
            var href = target.getAttribute("href");
            if (href && href.startsWith("#")) {
              var footnoteId = href.substring(1);
              showPopup(footnoteRef, footnoteId);
            }
            return;
          }

          // Check if we clicked the sup directly
          if (
            target.classList &&
            target.classList.contains("footnote-reference")
          ) {
            e.preventDefault();
            var link = target.querySelector("a");
            if (link) {
              var href = link.getAttribute("href");
              if (href && href.startsWith("#")) {
                var footnoteId = href.substring(1);
                showPopup(target, footnoteId);
              }
            }
            return;
          }

          // Close popup if clicking outside
          if (popup && popup.classList.contains("visible")) {
            if (!popup.contains(target) && target !== currentReference) {
              closePopup();
            }
          }
        });

        // Close popup on Escape key
        document.addEventListener("keydown", function (e) {
          if (
            e.key === "Escape" &&
            popup &&
            popup.classList.contains("visible")
          ) {
            closePopup();
          }
        });

        // Reposition on scroll/resize
        var repositionTimeout;
        function handleReposition() {
          if (
            popup &&
            popup.classList.contains("visible") &&
            currentReference
          ) {
            clearTimeout(repositionTimeout);
            repositionTimeout = setTimeout(function () {
              positionPopup(currentReference);
            }, 10);
          }
        }

        window.addEventListener("scroll", handleReposition);
        window.addEventListener("resize", handleReposition);
      })();
    </script>
  </body>
</html>
